version: 1.0
runtime: nodejs22

build:
  commands:
    pre-build:
      - rm -rf node_modules package-lock.json
      - npm install --include=dev
    build:
      - npm ci --include=dev
      - npx medusa build
      - echo ">>> Admin build output <<<"
      - ls -R .medusa/server/public/admin || echo "— no admin folder found —"

run:
  # Tell App Runner which port your app listens on, and which env var to use
  network:
    port: 8080
    env: MEDUSA_PORT
  # The start command for your service
  command: npx medusa start
  # Runtime environment variables
  run:
  env:
    - name: NODE_ENV
      value: production
    - name: MEDUSA_ADMIN_BACKEND_URL
      value: https://api.myshop.com
    - name: MEDUSA_PORT
      value: "8080"

    # Tell Medusa exactly where to find Postgres:
    - name: DATABASE_URL
      value: >-
        postgres://postgres:E_b09.lgR@
        database-1.cjuao6qq8txz.eu-central-1.rds.amazonaws.com:5432/database-1
        ?ssl=true&rejectUnauthorized=false

    # (Optional but explicit—avoids any dotenv or code fallback to localhost)
    - name: PGHOST
      value: database-1.cjuao6qq8txz.eu-central-1.rds.amazonaws.com
    - name: PGPORT
      value: "5432"
    - name: PGUSER
      value: postgres
    - name: PGPASSWORD
      value: E_b09.lgR
    - name: PGDATABASE
      value: database-1

    # Force SSL on every connection
    - name: PGSSLMODE
      value: require

    - name: JWT_SECRET
      value: 4k2f6b1c5d3a837e5c0d2b8e6f2a3d8c
