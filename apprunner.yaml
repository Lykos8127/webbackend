version: "1.0"
runtime: nodejs22

build:
  commands:
    pre-build:
      - rm -rf node_modules package-lock.json
      - npm install --include=dev
    build:
      - npm ci --include=dev
      - npx medusa build
      - echo ">>> Admin build output <<<"
      - ls -R .medusa/server/public/admin || echo "â€” no admin folder found â€”"

run:
  command:  |
    echo "DATABASE_URL is $DATABASE_URL"
    echo "REDIS_URL    is $REDIS_URL"
    npx medusa start
  env:
    - name: NODE_ENV
      value: production
    - name: MEDUSA_ADMIN_BACKEND_URL
      value: https://api.myshop.com
    - name: MEDUSA_PORT
      value: "8080"
    - name: DATABASE_URL
      value: postgres://postgres:E_b09.lgR@database-1.cjuao6qq8txz.eu-central-1.rds.amazonaws.com:5432/database-1?sslmode=require&sslrootcert=./certs/rds-ca-bundle.pem
    - name: JWT_SECRET
      value: "4k2f6b1c5d3a837e5c0d2b8e6f2a3d8c"

